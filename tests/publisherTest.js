const chai = require("chai");
const util = require("util");
const fs = require("fs");
const path = require("path");
const expect = chai.expect;
const {
  txpoolMutation,
  txMutation,
  createMutaionString,
  callMutation,
  runPublish,
  logger,
} = require("../publisher");

// setting arguments
const args = {
  layer: "l1",
  router: process.env.UNIVERSAL_ROUTER_ADDRESS,
  wss: process.env.RPC_WEBSOCKET_URL,
  graphql: process.env.GRAPHQL_URL,
  TxpoolMutation: "createTxnPoolData",
  TxpoolMutationMethod: "newTxnPoolData",
  TxnMutation: "createTxnData",
  TxnMutationMethod: "newTxnData",
};
const args2 = {
  layer: "l2",
  router: process.env.L2_UNIVERSAL_ROUTER_ADDRESS,
  wss: process.env.L2_RPC_WEBSOCKET_URL,
  graphql: process.env.GRAPHQL_URL,
  TxnMutation: "createl2TxnData",
  TxnMutationMethod: "newl2TxnData",
};

describe("Testing a mutation query string", () => {
  it("should return a propery query string", () => {
    const testFile = fs.readFileSync("tests/mutationQuery.json", "utf-8");
    expect(
      createMutaionString(
        fullData,
        args["TxnMutation"],
        args["TxnMutationMethod"]
      )
    ).to.eql(testFile);
  });
});

describe("Testing a mutation query", () => {
  it("should return a object which has hash data", async () => {
    const testFile = fs.readFileSync("tests/mutationQuery.json", "utf-8");
    const result = await callMutation(testFile)(args["graphql"]);
    console.log(result);
    expect(result).to.eql({
      data: {
        createTxnData: {
          hash: "0xe75845578015e7f99d804644ba312cb0d4702ce70a83b58be0ee42a27267fd2b",
        },
      },
    });
  });
});

// Test Data
const fullData = {
  provider: {},
  blockNumber: 18433746,
  blockHash:
    "0x0e1370a81b0f62388686b303cd0b959997660d84154ce97eb7592b03eab29733",
  hash: "0xe75845578015e7f99d804644ba312cb0d4702ce70a83b58be0ee42a27267fd2b",
  type: 2,
  to: "0x3fC91A3afd70395Cd496C647d5a6CC9D4B2b7FAD",
  from: "0x6d14dC1c9a744993Bc2a5f47833682c7EA795210",
  nonce: 340,
  gasLimit: "263437",
  gasPrice: "19942209296",
  maxPriorityFeePerGas: "100000000",
  maxFeePerGas: "29114876653",
  data: "0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000653a3f0b00000000000000000000000000000000000000000000000000000000000000030a080c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000160000000000000000000000000037a420ef8af0ecf4571c1cbd35cb351600affc3000000000000000000000000ffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006561c9b700000000000000000000000000000000000000000000000000000000000000000000000000000000000000003fc91a3afd70395cd496c647d5a6cc9d4b2b7fad00000000000000000000000000000000000000000000000000000000653a43bf00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000410e96452a04a822aa28dca21dc1ba6b206eee1b1c1f800cc0a994963de5ab30760f258bc73910926d826bd265623a547bd75f0ad9151c3e0b6e1c905341ccbb421c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000002cff2e2a4036700000000000000000000000000000000000000000000000004859b2f82d993c300000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000037a420ef8af0ecf4571c1cbd35cb351600affc3000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000004859b2f82d993c3",
  value: "0",
  chainId: "1",
  signature: {
    _type: "signature",
    networkV: null,
    r: "0x46dd5e086ca08c0f6e1de1852a91869de61f317f5137524f244650f10721dee1",
    s: "0x272d5ec08821d3b9ab410296cd6225ad191de1ab17edec27af9925ab0abe6265",
    v: 27,
  },
  accessList: [],
  decodedData: {
    contents: [
      [
        {
          command: "0a",
          value: "PERMIT2_PERMIT",
          inputType: [
            "tuple((address,uint160,uint48,uint48),address,uint256)",
            "bytes",
          ],
          decodedInput: [
            [
              [
                "0x037a420ef8af0ecf4571c1cbd35cb351600affc3",
                "1461501637330902918203684832716283019655932542975",
                "1700907447",
                "0",
              ],
              "0x3fc91a3afd70395cd496c647d5a6cc9d4b2b7fad",
              "1698317247",
            ],
            "0x0e96452a04a822aa28dca21dc1ba6b206eee1b1c1f800cc0a994963de5ab30760f258bc73910926d826bd265623a547bd75f0ad9151c3e0b6e1c905341ccbb421c",
          ],
        },
      ],
      [
        {
          command: "08",
          value: "V2_SWAP_EXACT_IN",
          inputType: ["address", "uint256", "uint256", "address[]", "bool"],
          decodedInput: [
            "0x0000000000000000000000000000000000000002",
            "791592044856167",
            "325837176415294403",
            [
              "0x037a420ef8af0ecf4571c1cbd35cb351600affc3",
              "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
            ],
            true,
          ],
        },
      ],
      [
        {
          command: "0c",
          value: "UNWRAP_WETH",
          inputType: ["address", "uint256"],
          decodedInput: [
            "0x0000000000000000000000000000000000000001",
            "325837176415294403",
          ],
        },
      ],
    ],
    deadline: "1698316043",
  },
  blockHeader: {
    _type: "Block",
    baseFeePerGas: "19842209296",
    difficulty: "0",
    extraData: "0x6265617665726275696c642e6f7267",
    gasLimit: "30000000",
    gasUsed: "10906068",
    hash: "0x0e1370a81b0f62388686b303cd0b959997660d84154ce97eb7592b03eab29733",
    miner: "0x95222290DD7278Aa3Ddd389Cc1E1d165CC4BAfe5",
    nonce: "0x0000000000000000",
    number: 18433746,
    parentHash:
      "0xb978249522a80f729d9896c50bb1c1674d323a49024d88db26336fa3bddf8fd3",
    timestamp: 1698315455,
    transactions: [
      "0xacc4cc11dd06062dd6a48a19337d1bb58ca5d3dc9d7438fe938f29dfe33c3e49",
      "0x830f811a8ed9ba143436dc130c074ec24bc61ae15d3e4db41c6d5c0f20917553",
      "0x41eec515d2d58f694578d1d93cd22334a945e13d415f8a588cef713cf9c28720",
      "0xe75845578015e7f99d804644ba312cb0d4702ce70a83b58be0ee42a27267fd2b",
      "0x88be8b4a0785aa83e2d2cee47eeab626316ed287bb90db02a3f15f70b7bc1c87",
      "0x31e3022cfeb6e78c1a92e804a2200d2745ffe7755dfd7b93fabaddee5202d240",
      "0x30e1fcfc402c5faa9f8804d47e5f5cc588c5ec3ca94bb1886412d74811a31299",
      "0x894971d6b0d87912ef165de551fe61cc48df12a942b537ea08aa50aec7447ee2",
      "0x63c972995cae37f3b76a301646ca940fdf96ca5720a75440e0f41bc5698a7097",
      "0x2afe0a73dff4be46aff47ad47fcdb355cee5d42426e7dd0ff2cda8ad64533da6",
      "0x25ace2016a5156ac0f6c5c72303d66207cc5ec624f99473e48ced0075c011b51",
      "0x2c81b832c353de24090a11fdeda9a7806d30b42eb781554fa0f4046e316624d1",
      "0x29cef8052d6841669eda64a53673bc515ba0c32664204052b88c5c91c38b8933",
      "0x909ed1d8d5fe11dd4d87696c92c1a8cc076cde83e7c4f68531445fbdd88a3fa5",
      "0xa17857a6389fb3d0fb31c972c6a4c25e5c66d2df119d864b2f59dc70be500bc1",
      "0x24309b485209e9b3378b82c2caceb6b235f0e2ccf2943bf4a68e8948ad8c85e6",
      "0x269c02bb0ddb49efa2cc2860ac396c004961ef9d1d6ec7e00d43c3d43442fa35",
      "0xeb804f600900b655823c133322b8ceef4389338cefda707ec623ef0e0932fcad",
      "0x98a313c5918ce66e71494f9fc0ce930f29a922037ed7c9d8fb0cca5d7a03e66e",
      "0x32cf6ee88347ac4b4ccdc33d05ad740e871db05ac4cfe1d0d6a04a40862e13da",
      "0x0523946948cb189217f2e7dd5881c91612838b42a2477d870fd6b9473f19a9c6",
      "0xc1359509fa588730a7c7ac0878e5f9b56e3975cfafbc354a760dcebb47e953f0",
      "0x4e7ec0b0c4179f5e8282d32684ebf29cd4474bcc9602dcb6574d713e3a0ded7b",
      "0xccab80d4a4a201f47db35c99d697999a85dec0abdb7476859df6b623792de53c",
      "0x6ea22e3527550daf8512954e3093dd340d649fc022ba91e24b807a5e9b4da447",
      "0x7d9d2fb07d60cdf53e21dbdaa55cbe0414d1f4c1257ca8512d329737080e94a0",
      "0xeba28560220bad7aeb8d67a4fe495bad1214b0af7a65790419496365b6a11c69",
      "0x5599097856161aa4466e2ad43e8ca5557f0fb7816916aa28432e28e5c06c5ef5",
      "0x73dff6a22547f22e985e7cb5ae15aa9901ca88eb66e160d1004157e5d8cdbd54",
      "0x5a686be4bc76296f60b4d84ca7af08232facde10a1a0cea8d4ad63503acde6bf",
      "0x98547bb4071cc7b6fcccb8186112a72f9ccd3e5e890603b7d001a2f75140132f",
      "0x8f19583fe5491162b09583c97b3ffa463e4df18de1efa1e72489959be11ef341",
      "0xa5ade5a90cafeaca7bc4df52a639ad2a6ae1b29d1707fbc8fe9c02b4cf23ba2b",
      "0x553faf7948ff1e7a2244f09feec36d7bbb760b71e99e6c4b018e7fe1f4689422",
      "0x0d802b8d2175349a2396c138810610d24532d4888ce3a31c717a7baa20f80cb9",
      "0x5703b62bc64c998acf17c6ebfc886d2123c926eca62ba0a335a31cff016f05f2",
      "0x465620df9f9f6fb21c4630b60650bf874a40c5af881db21c4670e2c9d88bc41c",
      "0xae9a462d98c5bbd0730cf5f8697cfc9cf286553fc4f2ea705d0d3a163f6ee1dd",
      "0x3f1a4e9ba425155785a636a481d33dbcdddc38125c4204d1c6bb0a409882b46b",
      "0xe2316b9c5637e179eff9049acdea9c4044246097f15e3d5286a9e110beed613f",
      "0x5a359f99acccf1123d444f55b6815a125d8ad8202ed83d78c3caf24356cede21",
      "0x46f725ce9d30ae0416b88d2f0d899a48f4885f30353209006f0c9a9670ef7c36",
      "0x92831bf10aa931f9e8a2ff768332255b57be5ee4774ef8dc2cf091405f92c2a2",
      "0x011acfd03f7943bf9753472414b67eadfeb1525b73ab3294ee8d1b9f6e19b4d3",
      "0xade712c8e86722d93bbdc3e9d41d00c49141b7fac6957bb43e51f7ddeeac298b",
      "0x9ee59a7d7a44cf78b8cf7288bb24edc8003052fbfd49eea7bc27289daa5b2653",
      "0xed229ea24a6592bc2d540a66a6d4a5af54d21cc694fabd694e2f1c1bf00eed2e",
      "0x728fa3605c9117c6ef3cc79ab02fa86f2158695bbe0aa1331a9fe987e34768cf",
      "0x23af330c031d58c650b536db3dfcd2bc614d5e61640905edd83dc5e6b1d4d8e4",
      "0x10a4d8ff57f90d3e68beca551fbf58c3596eeced3901d9fa8d7889795bbdfd79",
      "0x96f8410319aeddf1d43d39d2faa9ec9ed5e88e2cb9dd696bffdb9b381f2784f3",
      "0x96454d3a19f40121c75cda1352fae86c4f58865bf4a7fb91058e625749e73e43",
      "0x8356c16cd7814ffa1b8ecfd30a733e98045cdf3b5eeb32e589ac10aa8f18dd9b",
      "0x6369c7d5a11a0e318e58a24ee10b190331c47a12190f35d0a6f8ea741c17008b",
      "0xa4fb4f4bb6c173a61e6f3d169255a6893055fdc195dd58626bf2980b325d7032",
      "0x2bfaa2aa4a26a3c57c081ffc05fa692c3fc7d6f4e1708dfbc679b45e1749943f",
      "0x5316d629ba80d96dd90db1c67d26926eaefd0c519cac35ab7e9ccff9b41bd75e",
      "0xc46f95643bf9cd63d4d1d32f59d39e6f2c7c9194e19f0ac5d343f291d7c1227e",
      "0x2fb7cbe1ab9b9ce66be58e12e07c7867618fb6f48b6165d6b1a5d38826319f02",
      "0x4276c38188fa699b914b41b3624db1acd9cfe51ab49130a855383a801e7deaa9",
      "0x85307848251ee0ab2a3d66cce1b4e513b24081ddd03f84da41fff924464f1767",
      "0x72b3e216e507100a940b7308164719fc82553868514d9a03485282dcd9bc10d4",
      "0x22b506fa26c1256cb6b69bf3539575abcf8b1880910fa0fa65c698fa17be7eef",
      "0xbc39cfb7499b0e636e5f75e9eeb9c5ff9840a7ed766d420d1d112318d7b4be9e",
      "0x13949802e06eba577d8bb56ab579919bc6abf3d35dfb21b949a8f7c949fbfab7",
      "0x0cc454645da2bfed6148c2dccca7e29f42f742ae84d989de08d181ec7171084e",
      "0xcd082786aa3326a7543d0fe6738c0cd757581da12c3c23067e6f0bb30b742b63",
      "0xcf9b5e562a81504cbd3bc2b3c7ed9deae2ee0f1a474c9f05edf939b828203e2c",
      "0xb5e2fef1e6f1e939954bcbf30283e88a592440bc3ffd1351236ea3d53cd5ac5e",
      "0xe6ab00caefecf72393da8418959d067df1515fad97b225b443ba7f71c47a5e91",
      "0xeea0111f8bd1371eff99444ae857924795d837c215f5cb7f71d92fd24676e78e",
      "0x60e6c925acbebf1426928036373d617ad2b34a5dc281067bc433d7312b16e85f",
      "0x39e268988f8581e98d1d874641ad74081a70f3c420ed07fbd54286cc307b7bb7",
      "0xcf9a2542f8576f19605adad3c270cf17c4ed1750ba718f02639ca8531d6918a3",
      "0x3def2b4214e36a8c1e165968a2dc19804aca64a0b1cb7c572849f6c7e117295f",
      "0xe8afdafc9c4f02bc618b9e6428a1cee10f329c3f1e1a57e1ce43f5858ba35dcd",
      "0x2e3005416e6e0312b2be412452d37fafcf84c5ed91656fb5cde0691fb1b59638",
      "0x169664c0b25eba54c1c8fc6a97f0ece4eb9a3dab8a2084d63f6758ef7f46c392",
      "0x87e472c60c5ad795db9e330be2c17905218a00f9acaacf65240367603ead7210",
      "0x80855213de0010a2147adb8e4473da1bd14695e1734d7fdc1dd2fcba75225fa2",
      "0x758f099b88cf8e37782fb59961af2d030fac1c9691cd8aa35f8f2514692bd423",
      "0x56c7bb338018ae61c75808473743a7be25bf4bf00a0fd62714d90bebd8018dcd",
      "0xb2b100641ffe01e725919b0617a520de00e27d9afbac0cf5cda41ecaa91c90c3",
      "0x9dd7f9527e5bd0c47f7b8366824e66754115cc66163bdaa488754e52c3709a38",
      "0x8811577936e66719b1b828569306de0484c7d3d9d704890dc691d395433ab2a8",
      "0xc5eff62355053b2f619cb5f665b26975c25e1edd66171f21200366517c11170c",
      "0x37c33e55b6d41a5c96ce25c79a303e85fb0cbf00510259c6d9ee131e0804400b",
      "0x2573a21cead741939fb4a3a554c43734f53cd4ec378739493462edc8cf353d6f",
      "0x5ee51caa4c7c0c7588c3da7dee22df0585f334f3767fb96773408f57f5a1d1dc",
      "0xc823fcd193c8e789c870870f56b98c8ace0eb7f7b94e3554acf83b0c9ef0dec8",
      "0x592c3d5d648a755bc908186ce49a435cbbec99ff0b425cd9ed9528eb0c8388ce",
      "0x22c5dc22961b79f2fa62292cb1eaab42f16d70fe4dc6e751b87722a495876f13",
      "0xc5377283de8153ef420ccc463f28639592b33296bcace436ca8eb284ee6fdcde",
      "0x3c1038c8455185f08bc7425e62826bfc8d578b7b39e623e3deae8d5d80430cac",
      "0x0210b5c39c8c23f5549ec705b83dec5279995692876f14beb517ed9d6f93b3a8",
      "0x06b7289eb1bc89f7219e209c7afcff4dc13272ab939cc25b09abb6abc8a14cc3",
      "0xeb155852365728b3faef67245c73f308347b43820c6b489ffffb2a703f00a430",
      "0x631ddfc814613c351544c7ee74bdad0401d6db4d8485f501557b6fbca3965e3e",
      "0x10423bd1ecf97f2af3ecae865af17e16302475ca431c2e1cf782ebffff088fea",
      "0xef660188d1b67ae99ab55c3455716bbd983bb76fb7a4c44b823e1a150f2f5ded",
      "0x3c197e2fcaf40096516b02d97e5abf681bab8102cf1806d126f688484275b8e9",
      "0x6c0d8d32f20cf83617ff5916a1010d05bed4d32bf59fcd4d9e9ca640d57c926b",
      "0x64640d399bf74bd18e9bbc4f4f5dbd0c540c3aee07c85a32b51e7bead322694a",
      "0xdda24458d07a89c88b7426fbe37ec7113daf986f1cf37322fe88a6104303960d",
      "0x5461b2ef5dbb0645e9af924d35daa33f04243797bf8dc0f0d99311040ffb590f",
      "0xf755164880ca5382d4921d20d95e81a6566eff0ddfed79a7a957d9ae925f364c",
      "0xe877a21daf58b7c22b7d75c8fc3795ca5b7abf5b2daf5212145d0639d3a7549c",
      "0xe512642d05a7dbb662d48d919a769f49e2ff1de4fdacca64027685ea23e33e52",
      "0xab5fd851553ed450ef3bbe9c62d353dc8b10a5c7bcf8c2c81c484396f085c330",
      "0xaae454a18ba77d87497cc37965c0908c8ee9e56d1156f5f7f5f3dc14590211f5",
      "0x74a93b24ca1d983bd56171cd0531efcd5ab0e010b987ddf36f05ccd8d0a46935",
      "0x6d55f230118359e60637705e39188b4ccecbec73ab34546b30f843f020dc5067",
      "0x0d8c53ee1ed293971a7cce75fbe0f08bb9f99be475c0468aecac28f71cec5057",
      "0x0b1d22dbde0a35e36534f709617d91b911783a65d8c4a2ce118762656c445da8",
      "0x04ba7adb8d3a61d7bfbd30ba2ca62eb82e5e934869ca713cf0310d8063cf9dfd",
      "0xab8c27f9fac462daaed860dc67aaa4e2b7827d45eeac2a0ab9503b0a96d78b41",
      "0x6b82728133be834d679a02169b88a50c0827af34acea511d5663eb9c0dd9710b",
      "0xbb1c4b43a249cbbdb6765d98a7e7e30a6934de78958c5b859eb2ff9abf9e5f55",
      "0xa37e3f7c08292ecee5692f8a9aea1c354027314a6e5e03b119764806db3991b4",
      "0x4cab7735e58697d9c312e25b2078ae7ae0010fb703cbe7850f3e9a906ff24480",
      "0xcfa76b08b7ecc0d316a62340de305886f4268575180d111a1ec552244ac21e79",
      "0x9dda7dfc99e5d8aef0ba15c391c805d3a11ea22e472416be9d617015682e8cfa",
    ],
  },
  createdAt: "2023-10-26T10:17:47.726Z",
};
